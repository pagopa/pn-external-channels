openapi: 3.0.3
info:
  title:  API fornite dal normalizzatore
  version: 1.0.0
paths:
  /postel-mock/normalizzazione:
    post:
      operationId: normalizzazione
      summary: PN richiede la normalizzazione batch
      description: >-
        Il file in ingresso conterrà i seguenti campi gestiti con logica posizionale:
          - IdCodiceCliente : Id del cliente
          - Provincia : Sigla Provincia - opzionale
          - Cap : cap - opzionale
          - localita : località/comune - obbligatorio
          - localitaAggiuntiva : frazione - opzionale
          - indirizzo : svia - obbligatorio contiene la via completa DUG + TOPONIMO + CIVICO
          - stato : sstato – opzionale

      parameters:
        - $ref: '#/components/parameters/xPagopaAddrManCxId'
        - $ref: '#/components/parameters/xPagopaAddrManApiKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NormalizzazioneRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NormalizzazioneResponse'
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

  /postel-mock/deduplica:
    post:
      operationId: deduplica
      summary: PN richiede la deduplica online
      parameters:
        - $ref: '#/components/parameters/xPagopaAddrManCxId'
        - $ref: '#/components/parameters/xPagopaAddrManApiKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeduplicaRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeduplicaResponse'
        '400':
          description: Bad request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'
        '500':
          description: Internal error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/Problem'

components:


  parameters:
    xPagopaAddrManCxId:
      $ref: 'parameters-pn-address.yaml#/components/parameters/xPagopaAddrManCxId'
    xPagopaAddrManApiKey:
      $ref: 'parameters-pn-address.yaml#/components/parameters/xPagopaAddrManApiKey'


  schemas:
    NormalizzazioneRequest:
      type: object
      required:
        - requestId
        - sha256
        - uri
      properties:
        requestId:
          type: string
          minLength: 1
          maxLength: 250
          description: id lavorazione
        uri:
          type: string
          minLength: 5
          maxLength: 2000
          description: Le coordinate del documento correlato allo stato.
        sha256:
          type: string
          minLength: 40
          maxLength: 50
          description: sha256, codificato in base 64, del contenuto del file riferenziato dal campo uri
        idConf:
          type: string
          description: Eventuale configurazione speciale per la normalizzazione

    NormalizzazioneResponse:
      type: object
      required:
        - requestId
      properties:
        requestId:
          type: string
          minLength: 1
          maxLength: 250
          description: id lavorazione
        stato:
          type: string
        error:
          type: string
          description: >-
            identificativo dell'errore
            - _E01_ //FIXME elencare i casi
            - _E02_

    DeduplicaRequest:
      type: object
      properties:
        configIn:
          $ref: '#/components/schemas/ConfigIn'
        masterIn:
          $ref: '#/components/schemas/AddressIn'
        slaveIn:
          $ref: '#/components/schemas/AddressIn'

    ConfigIn:
      type: object
      properties:
        configurazioneDeduplica:
          type: string
        configurazioneNorm:
          type: string

    AddressIn:
      type: object
      properties:
        id:
          type: string
        provincia:
          type: string
        cap:
          type: string
        localita:
          type: string
        localitaAggiuntiva:
          type: string
        indirizzo:
          type: string
        stato:
          type: string

    DeduplicaResponse:
      type: object
      properties:
        masterOut:
          $ref: '#/components/schemas/AddressOut'
        slaveOut:
          $ref: '#/components/schemas/AddressOut'
        risultatoDedu:
          type: string
        erroreDedu:
          type: integer
        erroreGenerico:
          type: integer

    AddressOut:
      type: object
      properties:
        id:
          type: string
        nRisultatoNorm:
          type: integer
        nErroreNorm:
          type: integer
        sSiglaProv:
          type: string
        fPostalizzabile:
          type: string
        sStatoUff:
          type: string
        sStatoAbb:
          type: string
        sStatoSpedizione:
          type: string
        sComuneUff:
          type: string
        sComuneAbb:
          type: string
        sComuneSpedizione:
          type: string
        sFrazioneUff:
          type: string
        sFrazioneAbb:
          type: string
        sFrazioneSpedizione:
          type: string
        sCivicoAltro:
          type: string
        sCap:
          type: string
        sPresso:
          type: string
        sViaCompletaUff:
          type: string
        sViaCompletaAbb:
          type: string
        sViaCompletaSpedizione:
          type: string

    Problem:
      required:
        - type
        - status
        - title
        - errors
      properties:
        status:
          description: The HTTP status code generated by the origin server for this occurrence of the problem.
          type: integer
          format: int32
          example: 503
          maximum: 600
          minimum: 100
          exclusiveMaximum: true
        title:
          description: A short, summary of the problem type. Written in english and readable
          example: Service Unavailable
          maxLength: 64
          pattern: ^[ -~]{0,64}$
          type: string
        detail:
          description: A human readable explanation of the problem.
          example: Request took too long to complete.
          maxLength: 4096
          pattern: ^.{0,1024}$
          type: string
        traceId:
          description: Internal support identifier associated to error
          example: 123e4567-e89b-12d3-a456-426614174000
          type: string
        errors:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/ProblemError'

    ProblemError:
      required:
        - code
      properties:
        code:
          description: Internal code of the error, in human-readable format
          example: PN_PARAMETER_TOO_LONG | PN_PARAMETER_TOO_SHORT | PN_DUPLICATE_ENTRY | etc...
          type: string
        element:
          description: Parameter or request body field name for validation error
          example: 'body.order.item[2].quantity'
          type: string
        detail:
          description: A human readable explanation specific to this occurrence of the problem.
          example: Parameter not valid
          maxLength: 1024
          type: string
